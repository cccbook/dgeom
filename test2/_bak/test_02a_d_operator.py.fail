import sympy as sp
from dgeom.sym.dgeometry import Form, d_operator
from dgeom.sym._metrics import EUCLIDEAN_METRIC

# --------------------------------------------------
# I. 基礎設定
# --------------------------------------------------

# 座標變數
x, y, z = sp.symbols('x y z')
coords = [x, y, z]

# --------------------------------------------------
# II. 測試案例
# --------------------------------------------------

def test_d_operator_0_form():
    """
    測試: 0-Form (純量函數 f) 的外微分
    df = (∂f/∂x)dx + (∂f/∂y)dy + (∂f/∂z)dz
    """
    # 0-Form f = x^2 * y
    f = sp.sympify("x**2 * y")
    
    # 初始化 0-Form
    # 假設 Form(0, f) 會正確設置 coeffs_dict = {(): f}
    omega_0 = Form(0, f) 
    
    # 計算 df
    d_omega_0 = d_operator(omega_0, coords)
    
    # 預期結果:
    # ∂f/∂x = 2*x*y
    # ∂f/∂y = x^2
    # ∂f/∂z = 0
    # df = (2*x*y)dx + (x^2)dy
    
    # 係數字典的索引: (0,) 對應 dx, (1,) 對應 dy, (2,) 對應 dz
    expected_coeffs = {
        (0,): 2 * x * y, 
        (1,): x**2,
        (2,): 0
    }
    
    assert d_omega_0.k == 1
    # 使用 sp.simplify 來確保符號上的相等性
    for index, coeff in expected_coeffs.items():
        assert sp.simplify(d_omega_0.coeffs_dict.get(index, 0) - coeff) == 0
        
    print("Test Passed: Exterior Derivative of 0-Form")


def test_d_operator_1_form():
    """
    測試: 1-Form (omega = y*dx) 的外微分
    d(y*dx) = dy ^ dx = -dx ^ dy
    """
    # 1-Form omega_1 = y * dx
    # 係數字典: (0,) 對應 y (即 dx 的係數)
    omega_1 = Form(1, None, coeffs_dict={(0,): y})
    
    # 計算 d(omega_1)
    d_omega_1 = d_operator(omega_1, coords)
    
    # 預期結果: 2-Form
    # d(y*dx) = (∂y/∂x dx + ∂y/∂y dy + ∂y/∂z dz) ^ dx
    #         = (0 + 1*dy + 0) ^ dx
    #         = dy ^ dx = -dx ^ dy
    
    # 2-Form 的基底索引: (0, 1) 對應 dx^dy
    # 預期 (0, 1) 的係數為 -1
    expected_coeffs = {
        (0, 1): -1, # dx ^ dy
        (0, 2): 0,  # dx ^ dz
        (1, 2): 0   # dy ^ dz
    }
    
    assert d_omega_1.k == 2
    for index, coeff in expected_coeffs.items():
        assert sp.simplify(d_omega_1.coeffs_dict.get(index, 0) - coeff) == 0

    print("Test Passed: Exterior Derivative of 1-Form")


def test_d_operator_dd_is_zero():
    """
    測試: 雙重外微分為零 (d^2 = 0)
    d(d(f)) = 0
    """
    # 0-Form f = x * y * z
    f = sp.sympify("x * y * z")
    omega_0 = Form(0, f) 
    
    # 1. 計算 df (1-Form)
    d_omega_0 = d_operator(omega_0, coords)
    
    # 2. 計算 d(df) (2-Form)
    d_d_omega_0 = d_operator(d_omega_0, coords)
    
    # 預期結果: 係數字典為空或所有係數為零
    expected_k = 2
    
    is_zero = True
    for coeff in d_d_omega_0.coeffs_dict.values():
        if sp.simplify(coeff) != 0:
            is_zero = False
            break
            
    assert d_d_omega_0.k == expected_k
    assert is_zero
    
    print("Test Passed: Double Exterior Derivative (d^2 = 0)")


# 執行所有測試
if __name__ == "__main__":
    print("--- 執行外微分 (Exterior Derivative) 測試 ---")
    test_d_operator_0_form()
    test_d_operator_1_form()
    test_d_operator_dd_is_zero()
    print("--- 所有測試完成 ---")