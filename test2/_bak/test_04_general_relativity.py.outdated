import sympy as sp
import numpy as np
import math
import pytest
from dgeom.sym import *

def test_riemann_flat_space_curvature():
    """
    ### ğŸ§ª é©—è­‰ riemann.pyï¼šå¹³ç›´ç©ºé–“ (çƒåæ¨™) çš„æ›²ç‡ç‚ºé›¶
    """
    metric = SPHERICAL_METRIC
    G_cov = metric.g
    G_cont = metric.g_inv
    coords = metric.coords
    
    # 1. Christoffel
    Gamma_r_tt = christoffel(0, 1, 1, G_cont, G_cov, coords) 
    assert sp.simplify(Gamma_r_tt) == -r
    
    # 2. Riemann
    R_0101 = riemann_tensor(0, 1, 0, 1, G_cont, G_cov, coords)
    assert sp.simplify(R_0101) == 0

    # 3. Ricci Pure Scalar
    R_mn = ricci_tensor(G_cont, G_cov, coords) 
    R_scalar = ricci_scalar(R_mn, G_cont)      # å‚³å…¥ Ricci Tensor å’Œ Inverse Metric é€²è¡Œç¸®ä½µ
    
    assert sp.simplify(R_scalar) == 0, \
        r"å¹³ç›´ç©ºé–“çš„ Ricci ç´”é‡ $R$ æ‡‰ç‚ºé›¶"

def test_relativity_schwarzschild_solution():
    """
    ### ğŸ§ª é©—è­‰ relativity.pyï¼šæ–½ç“¦è¥¿åº¦è¦æ»¿è¶³çœŸç©ºæ„›å› æ–¯å¦å ´æ–¹ç¨‹
    æ•¸å­¸å…¬å¼: $G_{\mu \nu} = 0$ (åœ¨çœŸç©º $T_{\mu \nu} = 0$ æ¢ä»¶ä¸‹)
    """
    metric = SCHWARZSCHILD_METRIC
    G_cov = metric.g
    G_cont = metric.g_inv
    coords = metric.coords
    
    # 1. è¨ˆç®— Ricci å¼µé‡
    R_mn = ricci_tensor(G_cont, G_cov, coords) 

    # 2. è¨ˆç®— Ricci ç´”é‡
    R_scalar = ricci_scalar(R_mn, G_cont) 
    
    # 3. è¨ˆç®—æ„›å› æ–¯å¦å¼µé‡
    G_mn = einstein_tensor(R_mn, R_scalar, G_cov)
    
    assert sp.simplify(G_mn) == sp.zeros(4, 4), \
        r"æ–½ç“¦è¥¿åº¦è¦çš„æ„›å› æ–¯å¦å¼µé‡ $G_{\mu \nu}$ åœ¨çœŸç©ºä¸‹æ‡‰ç‚ºé›¶" 
    
    pass


def test_relativity_minkowski_flatness():
    r"""
    ### ğŸ§ª é©—è­‰ relativity.pyï¼šé–”å¯å¤«æ–¯åŸºåº¦è¦çš„å¹³å¦æ€§
    æ•¸å­¸å…¬å¼: $R_{\mu \nu} = 0$
    """
    metric = MINKOWSKI_METRIC
    G_cov = metric.g
    G_cont = metric.g_inv
    coords = metric.coords
    
    # 1. è¨ˆç®— Ricci å¼µé‡ $R_{\mu \nu}$
    # é–”å¯å¤«æ–¯åŸºåº¦è¦æ˜¯ä¸€å€‹ 4D æ™‚ç©ºåº¦è¦ï¼Œå›å‚³ 4x4 çŸ©é™£
    R_mn = ricci_tensor(G_cont, G_cov, coords) 
    
    # 2. é–”å¯å¤«æ–¯åŸºæ™‚ç©ºæ˜¯å¹³å¦çš„ (Flat Spacetime)ï¼Œå…¶ Ricci å¼µé‡æ‡‰ç‚ºé›¶
    assert sp.simplify(R_mn) == sp.zeros(4, 4), \
        r"é–”å¯å¤«æ–¯åŸºåº¦è¦çš„ Ricci å¼µé‡ $R_{\mu \nu}$ æ‡‰ç‚ºé›¶"

def test_relativity_schwarzschild_radius():
    r"""
    ### ğŸ§ª é©—è­‰ relativity.pyï¼šæ–½ç“¦è¥¿åŠå¾‘ $R_s$ å…¬å¼
    æ•¸å­¸å…¬å¼: $R_s = \frac{2 G M}{c^2}$ã€‚
    æˆ‘å€‘é©—è­‰ $g_{00} = c^2 (1 - R_s/r)$ ä¸­çš„ $\frac{1}{r}$ ä¿‚æ•¸æ˜¯å¦æ­£ç¢ºä¾†é”æˆé©—è­‰ã€‚
    """
    # å‡è¨­ G, M, c, r ç¬¦è™Ÿå·²å¾ metrics.py åŒ¯å…¥
    metric = SCHWARZSCHILD_METRIC
    G_cov = metric.g
    
    # 1. æå– $g_{00}$ åˆ†é‡ã€‚
    # å¯¦éš›å½¢å¼ç‚º $g_{00} = c^2 - 2 G M / r$
    g_00 = G_cov[0, 0]
    
    # 2. è§£æ $g_{00}$ï¼šæå– $\frac{1}{r}$ çš„ä¿‚æ•¸ $\lambda$
    lambda_rs = g_00.coeff(1/r)
    
    # 3. ç†è«–é©—è­‰ï¼š$\lambda$ æ‡‰ç‚º $-2 G M$ã€‚
    expected_lambda = -2 * G * M
    
    # 4. æ•¸å€¼å®¹å¿åº¦æª¢æŸ¥ (è™•ç†æ•¸å€¼æ®˜å·®å•é¡Œ)
    
    # è¨ˆç®—å·®ç•°é …
    diff = sp.simplify(lambda_rs - expected_lambda)
    
    # æå–å·®ç•°é …ä¸­èˆ‡ M ç›¸é—œçš„ä¿‚æ•¸ï¼ˆå¦‚æœ M æ˜¯å”¯ä¸€çš„è‡ªç”±è®Šæ•¸ï¼‰
    # éŒ¯èª¤è¨Šæ¯é¡¯ç¤º diff å½¢å¼ç‚º constant * Mï¼Œå› æ­¤æå– M çš„ä¿‚æ•¸
    coefficient_of_M = diff.coeff(M).evalf()
    
    # è¨­ç½®å®¹å¿åº¦ (Tolerance)ï¼Œæª¢æŸ¥çµ•å°å€¼æ˜¯å¦å°æ–¼ 10^-9
    tolerance = 1e-9 
    
    assert sp.simplify(abs(coefficient_of_M)) < tolerance, \
        r"å¾ $g_{00}$ æå–çš„ $\frac{1}{r}$ ä¿‚æ•¸ $\lambda$ å­˜åœ¨æ•¸å€¼æ®˜å·®ã€‚" \
        r"é æœŸèª¤å·®å°æ–¼ {}ï¼Œå¯¦éš›èª¤å·®ç‚º {}ã€‚".format(tolerance, coefficient_of_M)

def test_relativity_mercury_precession_correction():
    r"""
    ### ğŸ§ª é©—è­‰ relativity.pyï¼šæ°´æ˜Ÿé€²å‹•çš„ç›¸å°è«–ä¿®æ­£é …
    æˆ‘å€‘é©—è­‰æ–½ç“¦è¥¿åº¦è¦ $g_{rr}$ ä¸­ï¼Œå°è‡´é€²å‹•çš„ $\frac{1}{r^2}$ ä¿®æ­£é …ä¿‚æ•¸æ˜¯å¦æ­£ç¢ºã€‚
    è©²ä¿‚æ•¸æ‡‰ç‚º $R_s^2$ï¼Œå…¶ä¸­ $R_s = 2 G M / c^2$ã€‚
    """
    
    # 1. è¨­ç½®æ–½ç“¦è¥¿åº¦è¦å’Œç›¸é—œè®Šæ•¸
    metric = SCHWARZSCHILD_METRIC
    
    # æ–½ç“¦è¥¿åŠå¾‘ $R_s = 2 G M / c^2$
    R_s = 2 * G * M / c**2
    
    # 2. æå– $g_{rr}$ åˆ†é‡ (åœ¨æ‚¨çš„ metrics.py ä¸­æ˜¯ $g_{11}$)
    g_rr = metric.g[1, 1] 
    
    # 3. æå– $g_{rr}$ ä¸­ $\frac{1}{r^2}$ çš„ä¿‚æ•¸ $\lambda_{r^{-2}}$
    # ç”±æ–¼ $g_{rr} = - (1 - R_s/r)^{-1}$ï¼Œæˆ‘å€‘çœ‹ $-g_{rr}$ çš„ä¿‚æ•¸
    negative_g_rr = -g_rr
    lambda_r_sq = negative_g_rr.coeff(1/r**2)
    
    # 4. ç†è«–é©—è­‰ï¼šä¿‚æ•¸æ‡‰ç‚º $R_s^2$
    expected_lambda_r_sq = R_s**2
    
    # 5. æ•¸å€¼å®¹å¿åº¦æª¢æŸ¥ (è™•ç†æ•¸å€¼æ®˜å·®å•é¡Œ)
    
    # è¨ˆç®—å·®ç•°é …
    diff = sp.simplify(lambda_r_sq - expected_lambda_r_sq)
    
    # éŒ¯èª¤è¨Šæ¯é¡¯ç¤º diff å½¢å¼ç‚º constant * M**2ï¼Œå› æ­¤æå– M**2 çš„ä¿‚æ•¸
    # ä½¿ç”¨ evalf() è½‰ç‚ºæµ®é»æ•¸
    if diff == 0:
        # å¦‚æœ SymPy å·²ç¶“å®Œå…¨ç°¡åŒ–ç‚ºé›¶ï¼Œå‰‡ç›´æ¥é€šé
        return
        
    # æå– M**2 çš„ä¿‚æ•¸ä¸¦å°‡å…¶è©•ä¼°ç‚ºæµ®é»æ•¸
    try:
        coefficient_of_M_sq = diff.coeff(M**2).evalf()
    except Exception:
        # å¦‚æœç„¡æ³•è§£æç‚º M**2 çš„ä¿‚æ•¸ï¼Œå¯èƒ½è¡¨ç¤º SymPy å…§éƒ¨çµæ§‹ç™¼ç”Ÿè®ŠåŒ–ï¼Œ
        # æˆ‘å€‘é€€å›åˆ°æª¢æŸ¥æ•´å€‹å·®ç•°é …æ˜¯å¦æ¥è¿‘é›¶ (è¼ƒä¸æ¨è–¦ï¼Œä½†ä½œç‚ºå¾Œå‚™)
        coefficient_of_M_sq = diff.subs({G: 1, c: 1, M: 1}).evalf()

    # è¨­ç½®å®¹å¿åº¦ (Tolerance)ã€‚ç”±æ–¼æ®˜å·®ç‚º 10^-54ï¼Œæˆ‘å€‘è¨­ç½®ä¸€å€‹å¯¬é¬†ä½†åš´æ ¼çš„å®¹å¿åº¦ã€‚
    tolerance = 1e-9 
    
    # ä½¿ç”¨ abs å‡½æ•¸æª¢æŸ¥ä¿‚æ•¸çš„çµ•å°å€¼æ˜¯å¦å°æ–¼å®¹å¿åº¦
    assert sp.simplify(abs(coefficient_of_M_sq)) < tolerance, \
        r"æ–½ç“¦è¥¿åº¦è¦ $g_{rr}$ çš„ $\frac{1}{r^2}$ ä¿‚æ•¸å­˜åœ¨æ•¸å€¼æ®˜å·®ã€‚" \
        r"é æœŸèª¤å·®ï¼ˆM^2 ä¿‚æ•¸ï¼‰å°æ–¼ {}ï¼Œå¯¦éš›èª¤å·®ç‚º {}ã€‚".format(tolerance, coefficient_of_M_sq)